# Telegram Bot для запуска Airflow DAG

Этот бот позволяет запускать DAG в Apache Airflow с параметрами, полученными от пользователя через Telegram. Бот использует интеграцию с LLM (GigaChat) для понимания естественного языка и извлечения необходимых параметров из пользовательских запросов.

## Функциональность

- Понимает пользовательские запросы на естественном языке с помощью LLM GigaChat
- Извлекает из запросов период времени и список таблиц для загрузки
- Изменяет конфигурацию в переменных Airflow с переданными параметрами
- Запускает DAG через REST API Airflow
- Отслеживает статус выполнения DAG
- После завершения DAG восстанавливает исходную конфигурацию
- Проверяет ID пользователей Telegram для ограничения доступа

## Установка

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

2. Скопируйте файл `.env.example` в `.env` и заполните параметры:
   ```bash
   cp .env.example .env
   ```

   В файле `.env` нужно указать:
   - `TELEGRAM_TOKEN` - токен Telegram бота
   - `AIRFLOW_URL` - URL инстанса Airflow
   - `AIRFLOW_USERNAME` - имя пользователя для Airflow
   - `AIRFLOW_PASSWORD` - пароль для Airflow
   - `GIGACHAT_CREDENTIALS` - учетные данные для API GigaChat
   - `GIGACHAT_SCOPE` - область доступа GigaChat (по умолчанию: GIGACHAT_API_PERS)
   - `ALLOWED_USER_IDS` - список ID пользователей Telegram, которым разрешено использовать бота (через запятую)

## Использование

1. Запустите бота:
   ```bash
   python main.py
   ```

2. В Telegram отправьте сообщение на естественном языке, например:
   ```
   Обнови таблицу hrgate_employees_enr за февраль 2024-го
   ```

   Или:
   ```
   Запусти DAG для hrgate_units_enr и hrgate_employees_enr за март 2023
   ```

   Бот с помощью LLM проанализирует ваш запрос, извлечет необходимые параметры и выполнит соответствующие действия.

## Структура проекта

- `main.py` - точка входа в приложение
- `src/airflow/airflow_client.py` - клиент для взаимодействия с Airflow
- `src/bot/telegram_bot.py` - реализация Telegram бота
- `src/bot/llm_parser.py` - парсер сообщений с использованием LLM GigaChat
- `src/bot/airflow_config_manager.py` - менеджер конфигурации Airflow
- `src/bot/config/dag_mapping.json` - файл сопоставления DAG'ов и таблиц
- `.env` - файл с параметрами подключения (создается из .env.example)
- `requirements.txt` - зависимости проекта

## Конфигурация DAG'ов

Файл `src/bot/config/dag_mapping.json` содержит сопоставление между DAG'ами и таблицами, которые они обрабатывают. LLM использует эту информацию для определения, какой DAG следует запустить при получении запроса от пользователя. При добавлении новых DAG'ов или таблиц необходимо обновить этот файл.

Для ознакомления с форматом файла конфигурации DAG'ов доступен пример в файле `src/bot/config/dag_mapping_example.json`. Этот файл содержит обобщенные данные и может служить шаблоном для создания собственной конфигурации.

## Разработка

Для внесения изменений в код:
1. Отредактируйте соответствующие файлы
2. Убедитесь, что код соответствует стандартам Python (PEP 8)
3. Протестируйте изменения перед коммитом